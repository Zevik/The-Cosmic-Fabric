<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מארג היקום: לפענח את הקוד האלקטרומגנטי</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@700;800&family=Heebo:wght@300;400&display=swap" rel="stylesheet">
    
    <!-- ייבוא ספריית Three.js לשלב 2.1 -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    
    <style>
        /* --- משתני עיצוב גלובליים --- */
        :root {
            --bg-color: #02001a;
            --primary-text: #e0e0e0;
            --accent-cyan: #00ffff;
            --accent-magenta: #ff00ff;
            --accent-yellow: #ffff00;
            --accent-gold: #ffc400;
            --proton-color: #ff4d6d; /* גוון אדמדם-ורוד */
            --electron-color: #4da6ff; /* גוון כחלחל */
            --hydrogen-color: #e0e0e0; /* מימן */
            --oxygen-color: #ff4d6d; /* חמצן */
            --font-title: 'Assistant', sans-serif;
            --font-body: 'Heebo', sans-serif;
        }

        /* --- איפוס וסגנונות בסיס --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--primary-text);
            font-family: var(--font-body);
            direction: rtl;
        }

        /* --- מבנה המסכים הראשי --- */
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
            z-index: 10;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            z-index: 20;
        }

        /* --- רקע כוכבים אנימטיבי --- */
        #stars-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* --- מסך פתיחה --- */
        #intro-screen h1 {
            font-family: var(--font-title);
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 800;
            margin-bottom: 1rem;
            color: #fff;
            text-shadow: 0 0 10px #fff, 0 0 20px var(--accent-cyan), 0 0 30px var(--accent-magenta);
            animation: fadeInGlow 3s ease-in-out;
        }

        #intro-screen p {
            font-size: clamp(1rem, 3vw, 1.5rem);
            margin-bottom: 3rem;
            max-width: 600px;
            animation: fadeIn 3s 1s backwards;
        }
        
        #start-btn {
            font-family: var(--font-title);
            font-size: 1.5rem;
            font-weight: 700;
            padding: 1rem 3rem;
            border: 2px solid var(--accent-gold);
            border-radius: 50px;
            background-color: transparent;
            color: var(--accent-gold);
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, transform 0.3s, box-shadow 0.3s;
            animation: pulse 2s infinite, fadeIn 3s 1.5s backwards;
        }

        #start-btn:hover {
            background-color: var(--accent-gold);
            color: var(--bg-color);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-gold), 0 0 25px var(--accent-gold);
            animation-play-state: paused;
        }

        @keyframes fadeInGlow {
            from { opacity: 0; text-shadow: 0 0 5px #fff; }
            to { opacity: 1; text-shadow: 0 0 10px #fff, 0 0 20px var(--accent-cyan), 0 0 30px var(--accent-magenta); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 5px var(--accent-gold); }
            50% { box-shadow: 0 0 20px var(--accent-gold); }
            100% { box-shadow: 0 0 5px var(--accent-gold); }
        }

        /* --- שלב 1.1: ארגז החול של המטענים --- */
        #simulation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            cursor: grab;
        }
        #simulation-canvas:active {
            cursor: grabbing;
        }

        .controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            border-radius: 10px;
            padding: 1rem;
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .particle-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-family: var(--font-body);
            color: var(--primary-text);
            border-radius: 8px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s ease-out;
            background-color: transparent;
        }
        
        #add-proton-btn {
            border-color: var(--proton-color);
        }
        #add-proton-btn:hover {
            background-color: var(--proton-color);
            box-shadow: 0 0 10px var(--proton-color);
            color: #fff;
        }
        
        #add-electron-btn {
            border-color: var(--electron-color);
        }
        #add-electron-btn:hover {
            background-color: var(--electron-color);
            box-shadow: 0 0 10px var(--electron-color);
            color: #fff;
        }
        
        .particle-icon {
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 1;
        }

        #reset-btn {
            background: rgba(255,255,255,0.1);
            border: none;
        }
        #reset-btn:hover {
            background: var(--primary-text);
            color: var(--bg-color);
        }
        
        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            z-index: 30;
            font-size: 0.9rem;
        }
        
        /* --- שלב 1.2: מעבדת האטום --- */
        #atom-lab-container { position: relative; width: 100%; height: 100%; }
        #atom-canvas { display: block; width: 100%; height: 100%; }

        #ui-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            max-width: 350px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            z-index: 30;
        }

        #mission-title {
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }
        #mission-instructions { font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem; }
        #status-display { font-weight: bold; }
        #atom-status-text.status-unstable { color: var(--proton-color); }
        #atom-status-text.status-stable { color: var(--accent-gold); }
        #atom-status-text.status-negative { color: var(--electron-color); }

        #electron-source {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            z-index: 30;
        }
        #electron-source p { font-size: 0.8rem; margin-top: 10px; }

        #electron-draggable {
            width: 35px;
            height: 35px;
            background-color: var(--electron-color);
            border-radius: 50%;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 15px var(--electron-color), 0 0 30px var(--electron-color);
            transition: transform 0.2s, box-shadow 0.2s;
            animation: pulse-electron 2s infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        #electron-draggable:hover { 
            transform: scale(1.2); 
            box-shadow: 0 0 20px var(--electron-color), 0 0 40px var(--electron-color);
            animation-play-state: paused;
        }
        #electron-draggable:active { cursor: grabbing; }
        #electron-draggable::before { content: '-'; }
        
        @keyframes pulse-electron {
            0% { 
                box-shadow: 0 0 15px var(--electron-color), 0 0 30px var(--electron-color);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 25px var(--electron-color), 0 0 50px var(--electron-color);
                transform: scale(1.05);
            }
            100% { 
                box-shadow: 0 0 15px var(--electron-color), 0 0 30px var(--electron-color);
                transform: scale(1);
            }
        }

        #success-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: rgba(20, 20, 50, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent-gold);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #success-modal.hidden { display: none; }
        #success-modal h3 {
            font-family: var(--font-title);
            font-size: 2.5rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px var(--accent-gold);
        }
        #success-modal p { line-height: 1.6; margin-bottom: 2rem; }

        #next-stage-btn {
            font-family: var(--font-title);
            font-size: 1.2rem;
            padding: 0.8rem 2rem;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            background: transparent;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #next-stage-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--accent-gold);
        }

        /* --- שלב 2.1: הסוד המגנטי --- */
        #simulation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #magnetic-canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #magnetic-canvas:active {
            cursor: grabbing;
        }

        /* עיצוב ספציפי לשלב המגנטי */
        #stage-2-1-screen #simulation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #stage-2-1-screen #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            padding: 20px;
        }

        #stage-2-1-screen .controls-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
        }

        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            padding: 20px;
        }
        .panel {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            pointer-events: auto;
        }

        .instructions-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            max-width: 350px;
        }
        
        /* שלב המגנטי - פאנל בצד שמאל */
        #stage-2-1-screen .instructions-panel {
            right: auto;
            left: 20px;
        }
        .instructions-panel h3 {
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent-magenta);
            margin-bottom: 0.75rem;
        }
        .instructions-panel p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        .instructions-panel .tip {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .controls-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
        }
        .controls-panel label {
            font-family: var(--font-title);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .slider-wrapper {
            display: flex;
            width: 100%;
            align-items: center;
            gap: 15px;
        }
        .slider-wrapper span {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--accent-gold);
            border-radius: 50%;
            border: 3px solid var(--bg-color);
            box-shadow: 0 0 5px var(--accent-gold);
            transition: box-shadow 0.2s;
        }
        input[type="range"]:hover::-webkit-slider-thumb {
            box-shadow: 0 0 15px var(--accent-gold);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent-gold);
            border-radius: 50%;
            border: 3px solid var(--bg-color);
            box-shadow: 0 0 5px var(--accent-gold);
            transition: box-shadow 0.2s;
        }
        input[type="range"]:hover::-moz-range-thumb {
            box-shadow: 0 0 15px var(--accent-gold);
        }

        @keyframes vibrate {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-1px, 1px); }
            50% { transform: translate(1px, -1px); }
            75% { transform: translate(1px, 1px); }
            100% { transform: translate(-1px, -1px); }
        }

        .unstable-atom {
            animation: vibrate 0.1s infinite;
        }

        /* --- כפתורי ניווט קבועים --- */
        .nav-button {
            position: fixed;
            bottom: 20px;
            padding: 0.8rem 1.5rem;
            font-family: var(--font-title);
            font-weight: 700;
            font-size: 1rem;
            border: 2px solid var(--accent-gold);
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--accent-gold);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        .nav-button:hover {
            background: var(--accent-gold);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--accent-gold);
        }
        
        .next-button {
            left: 20px;
        }
        
        .prev-button {
            right: 20px;
        }

        /* --- שלב 2.2: סימפוניית האור --- */
        #wave-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #wave-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- שלב 3.1: ארכיטקט המולקולות --- */
        #molecule-lab-container { position: relative; width: 100%; height: 100%; }
        #molecule-canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #molecule-canvas:active { cursor: grabbing; }

        /* צבעי אטומים נוספים */

        #stage-3-1-screen .instructions-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            max-width: 350px;
        }
        #stage-3-1-screen .instructions-panel h3 {
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }
        #stage-3-1-screen .instructions-panel p { 
            font-size: 0.9rem; 
            line-height: 1.5; 
        }
        #stage-3-1-screen .instructions-panel strong { 
            color: var(--accent-gold); 
        }

        /* מגירת אטומים */
        #atom-drawer {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            z-index: 10;
        }
        #atom-drawer h4 {
            font-family: var(--font-title);
            margin-bottom: 0.5rem;
            color: var(--primary-text);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 0.5rem;
            width: 100%;
            text-align: center;
        }

        .atom-source {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .atom-source:hover { background-color: rgba(255,255,255,0.1); }
        .atom-source:active { cursor: grabbing; }

        .atom-icon {
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: var(--font-title);
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--bg-color);
        }
        .atom-icon.hydrogen { background-color: var(--hydrogen-color); }
        .atom-icon.oxygen { background-color: var(--oxygen-color); }

        #molecule-reset-btn {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--primary-text);
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--font-body);
        }
        #molecule-reset-btn:hover { 
            background: var(--primary-text); 
            color: var(--bg-color); 
        }

        /* מודל הצלחה למולקולות */
        #molecule-success-modal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 500px;
            background: rgba(20, 20, 50, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent-gold);
            border-radius: 15px;
            padding: 2rem; text-align: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #molecule-success-modal.hidden { display: none; }
        #molecule-success-modal h3 {
            font-family: var(--font-title); font-size: 2.5rem;
            color: var(--accent-gold); margin-bottom: 1rem;
            text-shadow: 0 0 10px var(--accent-gold);
        }
        #molecule-success-modal p { line-height: 1.6; margin-bottom: 2rem; }
        #molecule-next-stage-btn {
            font-family: var(--font-title); font-size: 1.2rem;
            padding: 0.8rem 2rem; border: 1px solid var(--accent-gold);
            color: var(--accent-gold); background: transparent;
            border-radius: 50px; cursor: pointer; transition: all 0.3s;
        }
        #molecule-next-stage-btn:hover {
            background: var(--accent-gold); color: var(--bg-color);
            box-shadow: 0 0 15px var(--accent-gold);
        }

        #wave-ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            padding: 20px;
        }

        #stage-2-2-screen .instructions-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            max-width: 350px;
        }
        #stage-2-2-screen .instructions-panel h3 {
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 0.75rem;
        }
        #stage-2-2-screen .instructions-panel p {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .wave-controls-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        #spectrum-info {
            font-family: var(--font-title);
            font-weight: 700;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 0 0 8px #fff;
            height: 30px;
        }

        #stage-2-2-screen .slider-wrapper { 
            width: 100%; 
        }
        #frequency-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: linear-gradient(to left, #f0f, #f00, #ff0, #0f0, #0ff, #00f);
            background-size: 100% 100%;
            background-position-x: 50%;
            background-repeat: no-repeat;
            border: 1px solid #555;
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }
        #frequency-slider::-webkit-slider-thumb {
            -webkit-appearance: none; 
            appearance: none;
            width: 20px; 
            height: 20px;
            background: #fff; 
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
        }
        #frequency-slider::-moz-range-thumb {
            width: 20px; 
            height: 20px;
            background: #fff; 
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
        }

        #spectrum-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 10px;
        }
        #spectrum-bar .label {
            font-size: clamp(0.6rem, 1.5vw, 0.8rem);
            color: #888;
            text-align: center;
            flex: 1;
            transition: color 0.3s, text-shadow 0.3s;
        }
        #spectrum-bar .label.active {
            color: #fff;
            text-shadow: 0 0 5px #fff;
        }
        #spectrum-bar .visible-light-label.active {
            color: var(--accent-gold);
            text-shadow: 0 0 8px var(--accent-gold);
        }

        /* --- שלב 3.2: מגרש המשחקים --- */
        #sandbox-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #sandbox-canvas { 
            display: block; width: 100%; height: 100%; 
            cursor: grab; 
        }
        #sandbox-canvas:active { cursor: grabbing; }

        #stage-3-2-screen #ui-container {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; padding: 20px;
        }

        /* ארגז כלים */
        .toolbox-panel {
            top: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .toolbox-panel h4 {
            font-family: var(--font-title); text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 0.5rem; margin-bottom: 0.5rem;
        }

        .tool-item {
            display: flex; align-items: center;
            gap: 10px; cursor: pointer;
            padding: 0.5rem; border-radius: 5px;
            transition: background-color 0.2s;
        }
        .tool-item:hover { background-color: rgba(255,255,255,0.1); }

        .tool-icon {
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-family: var(--font-title); font-weight: 800; font-size: 1.2rem;
        }
        .tool-icon.proton { background-color: var(--proton-color); color: white; }
        .tool-icon.electron { background-color: var(--electron-color); color: white; }
        .tool-icon.wire {
            background-color: #b87333;
            border-radius: 5px; height: 5px;
        }
        .tool-icon.magnet {
            background: linear-gradient(to bottom, var(--proton-color) 50%, var(--electron-color) 50%);
            border-radius: 5px; color: white; font-size: 1rem;
        }

        #sandbox-reset-btn {
            margin-top: 1rem; padding: 0.5rem;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: var(--primary-text); border-radius: 5px; cursor: pointer;
            font-family: var(--font-body);
        }
        #sandbox-reset-btn:hover { background: var(--primary-text); color: var(--bg-color); }

        /* פאנל שליטה לזרם */
        #sandbox-wire-controls {
            bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px;
        }
        #sandbox-wire-controls.hidden { display: none; }

        #stage-3-2-screen .instructions-panel {
            top: 20px; left: 20px; max-width: 350px;
        }
        #stage-3-2-screen .instructions-panel h3 {
            font-family: var(--font-title); font-weight: 700; color: var(--accent-gold);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- הרקע האנימטיבי יופעל באמצעות JS -->
        <canvas id="stars-bg"></canvas>

        <!-- מסך פתיחה -->
        <section id="intro-screen" class="screen active">
            <h1>מארג היקום</h1>
            <p>הכוח האלקטרומגנטי טווה את כל החומר שאנו מכירים, מהאטומים ועד לגלקסיות. האם תעז לפענח את הקוד?</p>
            <button id="start-btn">התחל לפענח</button>
        </section>

        <!-- שלב 1.1: ארגז החול של המטענים -->
        <section id="stage-1-1-screen" class="screen">
            <div class="controls-panel">
                <button id="add-proton-btn" class="particle-btn" title="הוסף פרוטון (מטען חיובי)">
                    <span class="particle-icon" style="color: var(--proton-color);">+</span>
                    <span>הוסף פרוטון</span>
                </button>
                <button id="add-electron-btn" class="particle-btn" title="הוסף אלקטרון (מטען שלילי)">
                     <span class="particle-icon" style="color: var(--electron-color);">-</span>
                    <span>הוסף אלקטרון</span>
                </button>
                <button id="reset-btn" class="particle-btn">אפס סימולציה</button>
            </div>
            
            <canvas id="simulation-canvas"></canvas>

            <div class="instructions">
                גרור חלקיקים למרחב וגלה כיצד הם מגיבים זה לזה. לחץ וגרור חלקיק קיים כדי להזיז אותו.
            </div>
            
            <!-- כפתורי ניווט -->
            <button id="to-stage-2-btn" class="nav-button next-button">לשלב הבא: מעבדת האטום ←</button>
        </section>

        <!-- שלב 1.2: מעבדת האטום -->
        <section id="stage-1-2-screen" class="screen">
            <div id="atom-lab-container">
                <div id="ui-panel">
                    <h2 id="mission-title">משימה: יצירת אטום יציב</h2>
                    <p id="mission-instructions">גרעין של הליום מכיל 2 פרוטונים. <strong>לחץ וגרור</strong> את האלקטרון הכחול מהמקור (צד שמאל) אל מסלול האלקטרונים (הקו המקווקו) כדי לאזן את המטען החשמלי.</p>
                    <div id="status-display">
                        סטטוס: <span id="atom-status-text" class="status-unstable">לא יציב (יון חיובי)</span>
                    </div>
                </div>

                <div id="electron-source">
                    <div id="electron-draggable" title="לחץ וגרור אותי למסלול!"></div>
                    <p><strong>לחץ וגרור ←</strong><br>מקור אלקטרונים</p>
                </div>
                
                <div id="success-modal" class="hidden">
                    <h3>יציב!</h3>
                    <p>הצלחת! יצרת אטום הליום ניטרלי ויציב. הכוחות החשמליים מאוזנים כעת. הכוח החזק שומר על הגרעין, והכוח האלקטרומגנטי קושר את האלקטרונים אליו.</p>
                    <button id="next-stage-btn">לשלב הבא: ריקוד השדות</button>
                </div>

                <canvas id="atom-canvas"></canvas>
            </div>
            
            <!-- כפתורי ניווט -->
            <button id="back-to-stage-1-btn" class="nav-button prev-button">→ חזור לארגז החול</button>
            <button id="to-stage-3-btn" class="nav-button next-button">לשלב הבא: הסוד המגנטי ←</button>
        </section>

        <!-- שלב 2.1: הסוד המגנטי -->
        <section id="stage-2-1-screen" class="screen">
            <div id="simulation-container">
                <canvas id="magnetic-canvas"></canvas>
            </div>

            <div id="ui-container">
                <div class="panel instructions-panel">
                    <h3>הסוד המגנטי</h3>
                    <p>לפניך תיל נחושת מלא באלקטרונים. במצב מנוחה, לא קורה דבר. השתמש במחוון כדי להזרים את האלקטרונים וגלה מה קורה במרחב שסביב התיל.</p>
                    <p class="tip"><strong>טיפ:</strong> לחץ וגרור עם העכבר כדי לסובב את המבט.</p>
                </div>

                <div class="panel controls-panel">
                    <label for="current-slider">מהירות זרם</label>
                    <div class="slider-wrapper">
                        <span>כבוי</span>
                        <input type="range" id="current-slider" min="0" max="100" value="0" aria-label="מחוון מהירות זרם">
                        <span>מירבי</span>
                    </div>
                </div>
            </div>
            
            <!-- כפתורי ניווט -->
            <button id="back-to-stage-2-btn" class="nav-button prev-button">→ חזור למעבדת האטום</button>
            <button id="to-stage-4-btn" class="nav-button next-button">לשלב הבא: סימפוניית האור ←</button>
        </section>

        <!-- שלב 2.2: סימפוניית האור -->
        <section id="stage-2-2-screen" class="screen">
            <div id="wave-container">
                <canvas id="wave-canvas"></canvas>
            </div>

            <div id="wave-ui-container">
                <div class="panel instructions-panel">
                    <h3>סימפוניית האור</h3>
                    <p>כל האור, הנראה והבלתי נראה, הוא גל אלקטרומגנטי: שדה חשמלי (בכחול) ושדה מגנטי (במג'נטה) הרוקדים יחד. הזז את מחוון התדר וגלה את כל הספקטרום האלקטרומגנטי.</p>
                </div>

                <div class="panel wave-controls-panel">
                    <div id="spectrum-info">
                        <span id="radiation-type">גלי רדיו</span>
                    </div>
                    <div class="slider-wrapper">
                        <input type="range" id="frequency-slider" min="0" max="1000" value="50" aria-label="מחוון תדר">
                    </div>
                    <div id="spectrum-bar">
                        <div class="label" data-range="radio">גלי רדיו</div>
                        <div class="label" data-range="microwave">מיקרוגל</div>
                        <div class="label" data-range="infrared">אינפרא-אדום</div>
                        <div class="label visible-light-label" data-range="visible">אור נראה</div>
                        <div class="label" data-range="uv">אולטרה-סגול</div>
                        <div class="label" data-range="xray">רנטגן</div>
                        <div class="label" data-range="gamma">גמא</div>
                    </div>
                </div>
            </div>
            
            <!-- כפתורי ניווט -->
            <button id="back-to-stage-3-btn" class="nav-button prev-button">→ חזור לסוד המגנטי</button>
            <button id="to-stage-5-btn" class="nav-button next-button">לשלב הבא: בניית מולקולות ←</button>
        </section>

        <!-- שלב 3.1: ארכיטקט המולקולות -->
        <section id="stage-3-1-screen" class="screen">
            <div id="molecule-lab-container">
                <canvas id="molecule-canvas"></canvas>

                <div class="panel instructions-panel">
                    <h3>ארכיטקט המולקולות</h3>
                    <p>הכוח האלקטרומגנטי קושר אטומים יחד ויוצר מולקולות. סביב כל אטום ישנן נקודות עגינה (אלקטרוני ערכיות).</p>
                    <p><strong>משימה:</strong> גרור אטומים ובנה מולקולת מים (H₂O) יציבה.</p>
                </div>

                <div id="atom-drawer" class="panel">
                    <h4>מגירת אטומים</h4>
                    <div class="atom-source" data-type="hydrogen" title="גרור אטום מימן (H)">
                        <div class="atom-icon hydrogen">H</div>
                        <span>מימן</span>
                    </div>
                    <div class="atom-source" data-type="oxygen" title="גרור אטום חמצן (O)">
                        <div class="atom-icon oxygen">O</div>
                        <span>חמצן</span>
                    </div>
                    <button id="molecule-reset-btn">איפוס</button>
                </div>
                
                <div id="molecule-success-modal" class="hidden">
                    <h3>מולקולה יציבה!</h3>
                    <p>כל הכבוד! יצרת מולקולת מים. שים לב כיצד אטום החמצן מושך אליו את האלקטרונים חזק יותר, מה שהופך אותו ל"קוטב שלילי" קטן ואת המימנים ל"קוטב חיובי" קטן. קוטביות זו היא סוד כוחם של המים.</p>
                    <button id="molecule-next-stage-btn">לשלב הסופי: מגרש המשחקים</button>
                </div>
            </div>
            
            <!-- כפתורי ניווט -->
            <button id="back-to-stage-4-btn" class="nav-button prev-button">→ חזור לסימפוניית האור</button>
            <button id="to-stage-6-btn" class="nav-button next-button">לשלב הסופי: מגרש המשחקים ←</button>
        </section>

        <!-- שלב 3.2: מגרש המשחקים -->
        <section id="stage-3-2-screen" class="screen">
            <div id="sandbox-container">
                <canvas id="sandbox-canvas"></canvas>
            </div>

            <div id="ui-container">
                <div class="panel instructions-panel">
                    <h3>מגרש המשחקים</h3>
                    <p>הגעת לסוף המסע. המרחב כולו שלך. השתמש בארגז הכלים כדי להוסיף אובייקטים, לשנות פרמטרים ולגלות את האינטראקציות המורכבות ביניהם. מה יקרה אם תשים מטען נע ליד מגנט? ומה יקרה לתיל עם זרם ליד מגנט אחר?</p>
                </div>

                <div class="panel toolbox-panel">
                    <h4>ארגז כלים</h4>
                    <div class="tool-item" data-type="proton" title="הוסף פרוטון (+)">
                        <div class="tool-icon proton">+</div><span>פרוטון</span>
                    </div>
                    <div class="tool-item" data-type="electron" title="הוסף אלקטרון (-)">
                        <div class="tool-icon electron">-</div><span>אלקטרון</span>
                    </div>
                    <div class="tool-item" data-type="wire" title="הוסף תיל מוליך">
                        <div class="tool-icon wire"></div><span>תיל מוליך</span>
                    </div>
                    <div class="tool-item" data-type="magnet" title="הוסף מגנט קבוע">
                        <div class="tool-icon magnet">N</div><span>מגנט קבוע</span>
                    </div>
                    <button id="sandbox-reset-btn">נקה הכל</button>
                </div>

                <div class="panel controls-panel hidden" id="sandbox-wire-controls">
                    <label for="sandbox-current-slider">עוצמת זרם בתיל</label>
                    <div class="slider-wrapper">
                        <input type="range" id="sandbox-current-slider" min="0" max="100" value="50">
                    </div>
                </div>
            </div>
            
            <!-- כפתורי ניווט -->
            <button id="back-to-stage-5-btn" class="nav-button prev-button">→ חזור למולקולות</button>
        </section>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- אתחול גלובלי ואלמנטים ---
        const app = {
            screens: {
                intro: document.getElementById('intro-screen'),
                stage1_1: document.getElementById('stage-1-1-screen'),
                stage1_2: document.getElementById('stage-1-2-screen'),
                stage2_1: document.getElementById('stage-2-1-screen'),
                stage2_2: document.getElementById('stage-2-2-screen'),
                stage3_1: document.getElementById('stage-3-1-screen'),
                stage3_2: document.getElementById('stage-3-2-screen'),
            },
            buttons: {
                start: document.getElementById('start-btn'),
                addProton: document.getElementById('add-proton-btn'),
                addElectron: document.getElementById('add-electron-btn'),
                reset: document.getElementById('reset-btn'),
                nextStage: document.getElementById('next-stage-btn'),
                toStage2: document.getElementById('to-stage-2-btn'),
                toStage3: document.getElementById('to-stage-3-btn'),
                toStage4: document.getElementById('to-stage-4-btn'),
                toStage5: document.getElementById('to-stage-5-btn'),
                toStage6: document.getElementById('to-stage-6-btn'),
                backToStage1: document.getElementById('back-to-stage-1-btn'),
                backToStage2: document.getElementById('back-to-stage-2-btn'),
                backToStage3: document.getElementById('back-to-stage-3-btn'),
                backToStage4: document.getElementById('back-to-stage-4-btn'),
                backToStage5: document.getElementById('back-to-stage-5-btn'),
                moleculeReset: document.getElementById('molecule-reset-btn'),
                moleculeNextStage: document.getElementById('molecule-next-stage-btn'),
                sandboxReset: document.getElementById('sandbox-reset-btn'),
            },
            canvases: {
                stars: document.getElementById('stars-bg'),
                simulation: document.getElementById('simulation-canvas'),
                atom: document.getElementById('atom-canvas'),
                magnetic: document.getElementById('magnetic-canvas'),
                wave: document.getElementById('wave-canvas'),
                molecule: document.getElementById('molecule-canvas'),
                sandbox: document.getElementById('sandbox-canvas'),
            },
            contexts: {},
            audioContext: null,
            activeScreen: 'intro',
        };

        // --- ניהול ניווט בין מסכים ---
        function switchScreen(screenName) {
            app.screens[app.activeScreen].classList.remove('active');
            app.screens[screenName].classList.add('active');
            app.activeScreen = screenName;
        }

        // --- אנימציית רקע כוכבים ---
        function setupStarsBackground() {
            const canvas = app.canvases.stars;
            const ctx = canvas.getContext('2d');
            app.contexts.stars = ctx;

            let stars = [];
            let numStars = 200;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                stars = [];
                for(let i = 0; i < numStars; i++) {
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        radius: Math.random() * 1.5,
                        alpha: Math.random(),
                        speed: 0.1 + Math.random() * 0.3
                    });
                }
            }

            function animateStars() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                stars.forEach(star => {
                    star.y -= star.speed;
                    if (star.y < 0) {
                        star.y = canvas.height;
                        star.x = Math.random() * canvas.width;
                    }
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                    ctx.fill();
                });
                requestAnimationFrame(animateStars);
            }
            
            window.addEventListener('resize', resize);
            resize();
            animateStars();
        }

        // --- מנוע הסימולציה האינטראקטיבית (שלב 1.1) ---
        const simulation = {
            particles: [],
            forceConstant: 500,
            damping: 0.98,
            isRunning: false,
            animationFrameId: null,
            draggedParticle: null,

            init() {
                const canvas = app.canvases.simulation;
                const ctx = canvas.getContext('2d');
                app.contexts.simulation = ctx;

                function resize() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
                
                window.addEventListener('resize', resize);
                resize();

                // אינטראקציות עכבר
                canvas.addEventListener('mousedown', this.onMouseDown.bind(this));
                canvas.addEventListener('mousemove', this.onMouseMove.bind(this));
                canvas.addEventListener('mouseup', this.onMouseUp.bind(this));
                canvas.addEventListener('mouseleave', this.onMouseUp.bind(this));
            },
            
            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.loop();
            },

            stop() {
                if (!this.isRunning) return;
                this.isRunning = false;
                cancelAnimationFrame(this.animationFrameId);
            },

            reset() {
                this.particles = [];
                const ctx = app.contexts.simulation;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            },
            
            addParticle(type) {
                const canvas = app.canvases.simulation;
                const charge = (type === 'proton') ? 1 : -1;
                const color = (type === 'proton') ? varToHex('--proton-color') : varToHex('--electron-color');
                
                this.particles.push({
                    x: Math.random() * (canvas.width - 200) + 100,
                    y: Math.random() * (canvas.height - 200) + 100,
                    vx: 0,
                    vy: 0,
                    radius: 12,
                    charge: charge,
                    color: color,
                    mass: 1,
                });
                playSound('add');
            },
            
            onMouseDown(e) {
                const rect = app.canvases.simulation.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    const dist = Math.sqrt((mouseX - p.x)**2 + (mouseY - p.y)**2);
                    if (dist < p.radius) {
                        this.draggedParticle = p;
                        playSound('grab');
                        break;
                    }
                }
            },
            
            onMouseMove(e) {
                if (this.draggedParticle) {
                    const rect = app.canvases.simulation.getBoundingClientRect();
                    this.draggedParticle.x = e.clientX - rect.left;
                    this.draggedParticle.y = e.clientY - rect.top;
                    this.draggedParticle.vx = 0;
                    this.draggedParticle.vy = 0;
                }
            },
            
            onMouseUp() {
                if(this.draggedParticle) {
                    playSound('release');
                    this.draggedParticle = null;
                }
            },
            
            update() {
                // חישוב כוחות
                for (let i = 0; i < this.particles.length; i++) {
                    const p1 = this.particles[i];
                    p1.fx = 0;
                    p1.fy = 0;
                    for (let j = 0; j < this.particles.length; j++) {
                        if (i === j) continue;
                        const p2 = this.particles[j];
                        
                        const dx = p2.x - p1.x;
                        const dy = p2.y - p1.y;
                        const distSq = dx * dx + dy * dy;
                        
                        // מניעת התנהגות קיצונית כשהחלקיקים קרובים מדי
                        if (distSq < 100) continue; 
                        
                        const dist = Math.sqrt(distSq);
                        const force = this.forceConstant * (p1.charge * p2.charge) / distSq;
                        
                        p1.fx -= force * dx / dist;
                        p1.fy -= force * dy / dist;
                    }
                }
                
                // עדכון מהירות ומיקום
                const canvas = app.canvases.simulation;
                this.particles.forEach(p => {
                    if (p === this.draggedParticle) return;
                    
                    const ax = p.fx / p.mass;
                    const ay = p.fy / p.mass;
                    
                    p.vx += ax;
                    p.vy += ay;
                    
                    p.vx *= this.damping;
                    p.vy *= this.damping;
                    
                    p.x += p.vx;
                    p.y += p.vy;
                    
                    // התנגשות בקירות
                    if (p.x < p.radius) { p.x = p.radius; p.vx *= -0.5; }
                    if (p.x > canvas.width - p.radius) { p.x = canvas.width - p.radius; p.vx *= -0.5; }
                    if (p.y < p.radius) { p.y = p.radius; p.vy *= -0.5; }
                    if (p.y > canvas.height - p.radius) { p.y = canvas.height - p.radius; p.vy *= -0.5; }
                });
            },

            draw() {
                const ctx = app.contexts.simulation;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                // ציור קווי כוח
                for (let i = 0; i < this.particles.length; i++) {
                    for (let j = i + 1; j < this.particles.length; j++) {
                        const p1 = this.particles[i];
                        const p2 = this.particles[j];
                        const dist = Math.sqrt((p1.x - p2.x)**2 + (p1.y - p2.y)**2);
                        const isAttractive = p1.charge * p2.charge < 0;

                        const opacity = Math.min(1, 200 / dist);

                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        
                        if (isAttractive) {
                            ctx.strokeStyle = `rgba(255, 196, 0, ${opacity * 0.7})`; // זהב למשיכה
                            ctx.lineWidth = 1.5;
                            ctx.setLineDash([]);
                        } else {
                             ctx.strokeStyle = `rgba(120, 120, 120, ${opacity * 0.5})`; // אפור לדחייה
                             ctx.lineWidth = 1;
                             ctx.setLineDash([5, 5]);
                        }
                        ctx.stroke();
                    }
                }
                ctx.setLineDash([]);

                // ציור חלקיקים
                this.particles.forEach(p => {
                    // זוהר
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius * 2, 0, Math.PI * 2);
                    const gradient = ctx.createRadialGradient(p.x, p.y, p.radius, p.x, p.y, p.radius * 2);
                    gradient.addColorStop(0, `${p.color}66`); // 40% opacity
                    gradient.addColorStop(1, `${p.color}00`); // 0% opacity
                    ctx.fillStyle = gradient;
                    ctx.fill();

                    // גוף החלקיק
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                    
                    // סימן (+ או -)
                    ctx.fillStyle = '#fff';
                    ctx.font = `bold ${p.radius * 1.5}px ${getComputedStyle(document.body).getPropertyValue('--font-title')}`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(p.charge > 0 ? '+' : '-', p.x, p.y + 1);
                });
            },
            
            loop() {
                this.update();
                this.draw();
                this.animationFrameId = requestAnimationFrame(this.loop.bind(this));
            }
        };

        // --- מערכת סאונד פשוטה (Web Audio API) ---
        function initAudio() {
            try {
                app.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch(e) {
                console.warn('Web Audio API is not supported in this browser.');
            }
        }
        
        function playSound(type) {
            if (!app.audioContext) return;
            
            const oscillator = app.audioContext.createOscillator();
            const gainNode = app.audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(app.audioContext.destination);

            gainNode.gain.setValueAtTime(0.1, app.audioContext.currentTime);

            switch(type) {
                case 'start':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(200, app.audioContext.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(800, app.audioContext.currentTime + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, app.audioContext.currentTime + 0.5);
                    break;
                case 'add':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, app.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, app.audioContext.currentTime + 0.2);
                    break;
                case 'grab':
                     oscillator.type = 'square';
                     oscillator.frequency.setValueAtTime(100, app.audioContext.currentTime);
                     gainNode.gain.exponentialRampToValueAtTime(0.0001, app.audioContext.currentTime + 0.1);
                     break;
                case 'release':
                     oscillator.type = 'square';
                     oscillator.frequency.setValueAtTime(150, app.audioContext.currentTime);
                     gainNode.gain.exponentialRampToValueAtTime(0.0001, app.audioContext.currentTime + 0.1);
                     break;
                case 'snap':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(660, app.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, app.audioContext.currentTime + 0.2);
                    break;
                case 'error':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(150, app.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, app.audioContext.currentTime + 0.1);
                    break;
                case 'stable':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, app.audioContext.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(783.99, app.audioContext.currentTime + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, app.audioContext.currentTime + 0.6);
                    break;
            }

            oscillator.start(app.audioContext.currentTime);
            if (['grab', 'release', 'error'].includes(type)) {
                oscillator.stop(app.audioContext.currentTime + 0.1);
            } else {
                oscillator.stop(app.audioContext.currentTime + 0.6);
            }
        }

        // --- כלי עזר ---
        // ממיר משתנה CSS לצבע HEX לשימוש בקנבס
        function varToHex(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        // --- חיבור אירועים (Event Listeners) ---
        function bindEvents() {
            app.buttons.start.addEventListener('click', () => {
                if(!app.audioContext) initAudio(); // אתחול אודיו באינטראקציית משתמש ראשונה
                playSound('start');
                switchScreen('stage1_1');
                simulation.start();
            });

            app.buttons.addProton.addEventListener('click', () => simulation.addParticle('proton'));
            app.buttons.addElectron.addEventListener('click', () => simulation.addParticle('electron'));
            app.buttons.reset.addEventListener('click', () => simulation.reset());
        }

        // --- שלב 1.2: מעבדת האטום ---
        const atomLab = {
            atom: {
                x: 0,
                y: 0,
                protons: 2,
                neutrons: 2,
                state: 'positive_ion',
                shell: {
                    radius: 0,
                    capacity: 2,
                    slots: [],
                },
                placedElectrons: [],
            },
            draggedElectron: null,
            isDragging: false,
            animationFrameId: null,
            isRunning: false,
            boundMouseDown: null,
            boundMouseMove: null,
            boundMouseUp: null,

            init() {
                if (this.isInitialized) {
                    return;
                }
                
                const canvas = app.canvases.atom;
                if (!canvas) {
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                app.contexts.atom = ctx;

                function resize() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    atomLab.atom.x = canvas.width / 2;
                    atomLab.atom.y = canvas.height / 2;
                    atomLab.atom.shell.radius = Math.min(canvas.width, canvas.height) / 4;
                    atomLab.calculateShellSlots();
                }
                
                window.addEventListener('resize', resize);
                resize();

                // שמירת bound functions לניקוי מאוחר יותר
                this.boundMouseDown = this.onMouseDown.bind(this);
                this.boundMouseMove = this.onMouseMove.bind(this);
                this.boundMouseUp = this.onMouseUp.bind(this);

                // הוספת event listeners
                document.addEventListener('mousedown', this.boundMouseDown);
                document.addEventListener('mousemove', this.boundMouseMove);
                document.addEventListener('mouseup', this.boundMouseUp);
                
                this.isInitialized = true;
            },

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.loop();
            },

            stop() {
                if (!this.isRunning) return;
                this.isRunning = false;
                cancelAnimationFrame(this.animationFrameId);
                
                // ניקוי event listeners
                if (this.boundMouseDown) {
                    document.removeEventListener('mousedown', this.boundMouseDown);
                    document.removeEventListener('mousemove', this.boundMouseMove);
                    document.removeEventListener('mouseup', this.boundMouseUp);
                }
            },

            reset() {
                // עצירת הלולאה אם רצה
                this.stop();
                
                // איפוס כל המשתנים
                this.atom.placedElectrons = [];
                this.atom.state = 'positive_ion';
                this.draggedElectron = null;
                this.isDragging = false;
                this.isInitialized = false;
                
                // איפוס המצב והמקומות
                this.calculateShellSlots();
                this.atom.shell.slots.forEach(slot => slot.occupied = false);
                this.updateAtomState();
                
                // הסתרת מודל ההצלחה
                const successModal = document.getElementById('success-modal');
                if (successModal) {
                    successModal.classList.add('hidden');
                    successModal.style.opacity = '0';
                }
            },

            calculateShellSlots() {
                this.atom.shell.slots = [];
                for (let i = 0; i < this.atom.shell.capacity; i++) {
                    const angle = (i / this.atom.shell.capacity) * Math.PI * 2 + Math.PI/2;
                    this.atom.shell.slots.push({
                        x: this.atom.x + this.atom.shell.radius * Math.cos(angle),
                        y: this.atom.y + this.atom.shell.radius * Math.sin(angle),
                        occupied: false,
                    });
                }
            },

            updateAtomState() {
                const electronCount = this.atom.placedElectrons.length;
                const statusText = document.getElementById('atom-status-text');
                let oldState = this.atom.state;
                
                if (electronCount < this.atom.protons) {
                    this.atom.state = 'positive_ion';
                    statusText.textContent = 'לא יציב (יון חיובי)';
                    statusText.className = 'status-unstable';
                } else if (electronCount > this.atom.protons) {
                    this.atom.state = 'negative_ion';
                    statusText.textContent = 'לא יציב (יון שלילי)';
                    statusText.className = 'status-negative';
                } else {
                    this.atom.state = 'stable';
                    statusText.textContent = 'יציב!';
                    statusText.className = 'status-stable';
                    if (oldState !== 'stable') {
                        playSound('stable');
                        this.showSuccess();
                    }
                }
            },

            showSuccess() {
                const successModal = document.getElementById('success-modal');
                successModal.classList.remove('hidden');
                setTimeout(() => { successModal.style.opacity = '1'; }, 10);
            },

            onMouseDown(e) {
                if (!app.audioContext) initAudio(); // אתחול אודיו באינטראקציה ראשונה
                
                const sourceEl = document.getElementById('electron-draggable');
                if (!sourceEl) return;
                
                const rect = sourceEl.getBoundingClientRect();
                const mouseX = e.clientX;
                const mouseY = e.clientY;

                if (mouseX >= rect.left && mouseX <= rect.right && mouseY >= rect.top && mouseY <= rect.bottom) {
                    if (this.atom.state === 'stable') return;
                    
                    e.preventDefault();
                    this.isDragging = true;
                    
                    // המרת מיקום העכבר לקואורדינטות קנבס
                    const canvas = app.canvases.atom;
                    const canvasRect = canvas.getBoundingClientRect();
                    const canvasX = mouseX - canvasRect.left;
                    const canvasY = mouseY - canvasRect.top;
                    
                    this.draggedElectron = { x: canvasX, y: canvasY };
                    sourceEl.style.cursor = 'grabbing';
                    playSound('grab');
                }
            },

            onMouseMove(e) {
                if (!this.isDragging || !this.draggedElectron) return;
                
                // המרת מיקום העכבר לקואורדינטות קנבס
                const canvas = app.canvases.atom;
                const rect = canvas.getBoundingClientRect();
                const canvasX = e.clientX - rect.left;
                const canvasY = e.clientY - rect.top;
                
                this.draggedElectron.x = canvasX;
                this.draggedElectron.y = canvasY;
            },

            onMouseUp(e) {
                if (!this.isDragging || !this.draggedElectron) return;
                
                this.isDragging = false;
                const sourceEl = document.getElementById('electron-draggable');
                if (sourceEl) sourceEl.style.cursor = 'grab';

                // המרת מיקום העכבר לקואורדינטות קנבס
                const canvas = app.canvases.atom;
                const rect = canvas.getBoundingClientRect();
                const canvasX = e.clientX - rect.left;
                const canvasY = e.clientY - rect.top;

                let snapped = false;
                for (const slot of this.atom.shell.slots) {
                    if (slot.occupied) continue;
                    
                    const dist = Math.sqrt((canvasX - slot.x)**2 + (canvasY - slot.y)**2);
                    if (dist < 80) {
                        slot.occupied = true;
                        this.atom.placedElectrons.push({ x: slot.x, y: slot.y });
                        snapped = true;
                        playSound('snap');
                        break;
                    }
                }
                
                if (!snapped) {
                    playSound('error');
                }
                
                this.draggedElectron = null;
                this.updateAtomState();
            },

            drawCircle(x, y, radius, color, text = null) {
                const ctx = app.contexts.atom;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                if (text) {
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${radius*1.5}px ${varToHex('--font-title')}`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, x, y);
                }
            },

            draw() {
                const ctx = app.contexts.atom;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                // רקע זוהר
                if (this.atom.state === 'stable') {
                    const glowColor = varToHex('--stable-glow-color');
                    const gradient = ctx.createRadialGradient(this.atom.x, this.atom.y, 30, this.atom.x, this.atom.y, this.atom.shell.radius + 20);
                    gradient.addColorStop(0, `#ffffff99`);
                    gradient.addColorStop(1, `#ffffff00`);
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.atom.x, this.atom.y, this.atom.shell.radius + 30, 0, Math.PI*2);
                    ctx.fill();
                }

                // מסלול אלקטרונים
                ctx.beginPath();
                ctx.arc(this.atom.x, this.atom.y, this.atom.shell.radius, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 10]);
                ctx.stroke();
                ctx.setLineDash([]);

                // גרעין
                ctx.save();
                if (this.atom.state !== 'stable') {
                    const vibeX = (Math.random() - 0.5) * 2;
                    const vibeY = (Math.random() - 0.5) * 2;
                    ctx.translate(vibeX, vibeY);
                }
                
                const positions = [[-8, -5], [8, 5], [8, -8], [-8, 8]];
                for (let i = 0; i < this.atom.protons; i++) {
                    this.drawCircle(this.atom.x + positions[i][0], this.atom.y + positions[i][1], 10, varToHex('--proton-color'), '+');
                }
                for (let i = 0; i < this.atom.neutrons; i++) {
                    this.drawCircle(this.atom.x + positions[i+2][0], this.atom.y + positions[i+2][1], 10, '#888');
                }
                ctx.restore();

                // אלקטרונים
                this.atom.placedElectrons.forEach(e => {
                    this.drawCircle(e.x, e.y, 8, varToHex('--electron-color'), '-');
                });

                if (this.draggedElectron) {
                    this.drawCircle(this.draggedElectron.x, this.draggedElectron.y, 10, varToHex('--electron-color'), '-');
                }
            },

            loop() {
                this.draw();
                this.animationFrameId = requestAnimationFrame(this.loop.bind(this));
            }
        };

        // --- שלב 2.1: הסוד המגנטי ---
        const magneticStage = {
            scene: null,
            camera: null,
            renderer: null,
            controls: null,
            wire: null,
            electrons: [],
            magneticFieldRings: [],
            humOscillator: null,
            humGain: null,
            isInitialized: false,
            animationFrameId: null,
            config: {
                electronSpeed: 0,
                fieldIntensity: 0,
            },

            async init() {
                if (this.isInitialized) return;
                
                try {
                    // ייבוא דינמי של Three.js
                    const THREE = await import('three');
                    const { OrbitControls } = await import('three/addons/controls/OrbitControls.js');
                    
                    // סצנה
                    this.scene = new THREE.Scene();
                    this.scene.fog = new THREE.Fog(0x02001a, 10, 30);

                    // מצלמה
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    this.camera.position.set(0, 3, 6);

                    // רנדרר
                    const canvas = document.getElementById('magnetic-canvas');
                    this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

                    // בקרת מצלמה
                    this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                    this.controls.enableDamping = true;
                    this.controls.minDistance = 3;
                    this.controls.maxDistance = 15;

                    // תאורה
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
                    this.scene.add(ambientLight);
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(5, 5, 5);
                    this.scene.add(directionalLight);
                    
                    // יצירת האובייקטים
                    this.createWire(THREE);
                    this.createElectrons(THREE);
                    this.createMagneticField(THREE);

                    // אתחול אירועים
                    this.bindEvents();
                    
                    this.isInitialized = true;
                    this.animate();
                    
                } catch (error) {
                    console.error('שגיאה בטעינת Three.js:', error);
                }
            },

            createWire(THREE) {
                const geometry = new THREE.CylinderGeometry(0.1, 0.1, 20, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xb87333, // צבע נחושת
                    metalness: 0.8, 
                    roughness: 0.3 
                });
                this.wire = new THREE.Mesh(geometry, material);
                this.wire.rotation.z = Math.PI / 2; // להשכיב את התיל
                this.scene.add(this.wire);
            },

            createElectrons(THREE) {
                const electronGeometry = new THREE.SphereGeometry(0.08, 16, 16);
                const electronMaterial = new THREE.MeshBasicMaterial({ color: 0x4da6ff });
                for (let i = 0; i < 50; i++) {
                    const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                    electron.position.x = (Math.random() - 0.5) * 19;
                    this.electrons.push(electron);
                    this.wire.add(electron); // הוספת האלקטרון כילד של התיל
                }
            },

            createMagneticField(THREE) {
                const ringGeometry = new THREE.TorusGeometry(1, 0.03, 16, 100);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff00ff, // צבע מג'נטה
                    transparent: true,
                    opacity: 0, // מתחיל שקוף
                    side: THREE.DoubleSide
                });
                
                for (let i = 0; i < 15; i++) {
                    const ring = new THREE.Mesh(ringGeometry, ringMaterial.clone());
                    ring.scale.set(1,1,0.2 * i + 0.5);
                    ring.rotation.x = Math.PI / 2;
                    this.magneticFieldRings.push(ring);
                    this.scene.add(ring);
                }
            },

            animate() {
                this.animationFrameId = requestAnimationFrame(this.animate.bind(this));

                // עדכון אלקטרונים
                this.electrons.forEach(electron => {
                    electron.position.x += this.config.electronSpeed;
                    if (electron.position.x > 10) {
                        electron.position.x = -10;
                    }
                });
                
                // עדכון שדה מגנטי
                this.magneticFieldRings.forEach((ring, index) => {
                    ring.material.opacity = this.config.fieldIntensity * (1 - index / this.magneticFieldRings.length) * 0.7;
                    // סיבוב קל להוספת דינמיות
                    ring.rotation.z += this.config.electronSpeed * 0.1;
                });

                if (this.controls) this.controls.update();
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            },

            initAudio() {
                if (this.humOscillator || !app.audioContext) return;
                try {
                    this.humOscillator = app.audioContext.createOscillator();
                    this.humGain = app.audioContext.createGain();

                    this.humOscillator.type = 'sawtooth';
                    this.humOscillator.frequency.value = 50;
                    this.humGain.gain.value = 0; // מתחיל שקט

                    this.humOscillator.connect(this.humGain);
                    this.humGain.connect(app.audioContext.destination);
                    this.humOscillator.start();
                } catch (e) {
                    console.warn('שגיאה באתחול אודיו לשלב המגנטי:', e);
                }
            },

            updateSound(intensity) {
                if (!this.humGain || !app.audioContext) return;
                // עוצמת הקול תלויה בעוצמת הזרם
                this.humGain.gain.setTargetAtTime(intensity * 0.05, app.audioContext.currentTime, 0.1);
                // תדר הקול עולה מעט עם הזרם
                this.humOscillator.frequency.setTargetAtTime(50 + intensity * 50, app.audioContext.currentTime, 0.1);
            },

            bindEvents() {
                const slider = document.getElementById('current-slider');
                if (!slider) return;
                
                slider.addEventListener('input', (e) => {
                    const value = e.target.value / 100; // נרמול לטווח 0-1
                    
                    // אתחול סאונד באינטראקציה ראשונה
                    this.initAudio();

                    this.config.electronSpeed = value * 0.1;
                    this.config.fieldIntensity = value;
                    
                    this.updateSound(value);
                });

                window.addEventListener('resize', () => {
                    if (this.camera && this.renderer) {
                        this.camera.aspect = window.innerWidth / window.innerHeight;
                        this.camera.updateProjectionMatrix();
                        this.renderer.setSize(window.innerWidth, window.innerHeight);
                    }
                });
            },

            stop() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                if (this.humOscillator) {
                    this.humOscillator.stop();
                    this.humOscillator = null;
                    this.humGain = null;
                }
            }
        };

        function setupMagneticStage() {
            magneticStage.init();
        }

        // --- שלב 3.1: ארכיטקט המולקולות ---
        const moleculeStage = {
            canvas: null,
            ctx: null,
            atomSources: null,
            resetButton: null,
            successModal: null,
            atoms: [],
            bonds: [],
            draggedAtom: null,
            dragOffset: { x: 0, y: 0 },
            puzzleSolved: false,
            isInitialized: false,
            animationFrameId: null,

            ATOM_PROPERTIES: {
                hydrogen: {
                    radius: 20, color: '--hydrogen-color', text: 'H',
                    slots: [{ angle: 0, occupied: false }]
                },
                oxygen: {
                    radius: 30, color: '--oxygen-color', text: 'O',
                    slots: [{ angle: -1.823, occupied: false }, { angle: 1.823, occupied: false }]
                }
            },

            init() {
                if (this.isInitialized) return;
                
                this.canvas = app.canvases.molecule;
                this.ctx = this.canvas.getContext('2d');
                this.atomSources = document.querySelectorAll('.atom-source');
                this.resetButton = app.buttons.moleculeReset;
                this.successModal = document.getElementById('molecule-success-modal');

                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                this.bindEvents();
                this.isInitialized = true;
                this.animate();
            },

            createAtom(type, x, y) {
                const props = this.ATOM_PROPERTIES[type];
                const atom = {
                    id: Date.now() + Math.random(), type, x, y,
                    radius: props.radius, 
                    color: varToHex(props.color), 
                    text: props.text,
                    rotation: 0,
                    slots: JSON.parse(JSON.stringify(props.slots)),
                    bonds: [],
                    vibrate: 0
                };
                this.atoms.push(atom);
                return atom;
            },

            reset() {
                this.atoms = [];
                this.bonds = [];
                this.puzzleSolved = false;
                this.successModal.classList.add('hidden');
                this.successModal.style.opacity = '0';
            },

            checkWinCondition() {
                const oxygenAtoms = this.atoms.filter(a => a.type === 'oxygen');
                if (oxygenAtoms.length !== 1) return false;
                
                const oxygen = oxygenAtoms[0];
                if (oxygen.bonds.length !== 2) return false;

                const bondedAtoms = oxygen.bonds.map(bondId => this.bonds.find(b => b.id === bondId)).map(bond => bond.atom2);
                const areBothHydrogen = bondedAtoms.every(atomId => this.atoms.find(a => a.id === atomId).type === 'hydrogen');

                if (areBothHydrogen) {
                    this.puzzleSolved = true;
                    playSound('stable');
                    this.centerAndShowSuccess([oxygen, ...bondedAtoms.map(id => this.atoms.find(a => a.id === id))]);
                }
            },

            centerAndShowSuccess(moleculeAtoms) {
                setTimeout(() => {
                    this.successModal.classList.remove('hidden');
                    setTimeout(() => this.successModal.style.opacity = '1', 10);
                }, 1500);
            },

            animate() {
                this.draw();
                this.animationFrameId = requestAnimationFrame(this.animate.bind(this));
            },

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.bonds.forEach(bond => this.drawBond(bond));
                this.atoms.forEach(atom => this.drawAtom(atom));

                if (this.puzzleSolved) {
                    this.drawPolarityAnimation();
                }
            },

            drawAtom(atom) {
                this.ctx.save();
                this.ctx.translate(atom.x, atom.y);
                this.ctx.rotate(atom.rotation);

                if(atom.vibrate > 0) {
                    this.ctx.translate((Math.random()-0.5)*4, (Math.random()-0.5)*4);
                    atom.vibrate--;
                }

                // צל
                this.ctx.beginPath();
                this.ctx.arc(0, 0, atom.radius + 2, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(0,0,0,0.3)';
                this.ctx.fill();

                // גוף האטום
                this.ctx.beginPath();
                this.ctx.arc(0, 0, atom.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = atom.color;
                this.ctx.fill();
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 2;
                this.ctx.stroke();

                // נקודות עגינה
                if (!this.puzzleSolved) {
                    atom.slots.forEach(slot => {
                        if (!slot.occupied) {
                            const slotX = Math.cos(slot.angle) * (atom.radius + 10);
                            const slotY = Math.sin(slot.angle) * (atom.radius + 10);
                            this.ctx.beginPath();
                            this.ctx.arc(slotX, slotY, 5, 0, Math.PI * 2);
                            this.ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';
                            this.ctx.fill();
                        }
                    });
                }

                // טקסט
                this.ctx.rotate(-atom.rotation);
                this.ctx.fillStyle = '#111';
                this.ctx.font = `bold ${atom.radius}px ${varToHex('--font-title')}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(atom.text, 0, 0);

                this.ctx.restore();
            },

            drawBond(bond) {
                const atom1 = this.atoms.find(a => a.id === bond.atom1);
                const atom2 = this.atoms.find(a => a.id === bond.atom2);
                if (!atom1 || !atom2) return;
                
                this.ctx.beginPath();
                this.ctx.moveTo(atom1.x, atom1.y);
                this.ctx.lineTo(atom2.x, atom2.y);
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                this.ctx.lineWidth = 8;
                this.ctx.stroke();
            },

            polarityPhase: 0,
            drawPolarityAnimation() {
                this.polarityPhase += 0.02;
                const oxygen = this.atoms.find(a => a.type === 'oxygen');
                if (!oxygen) return;
                
                const opacity = Math.abs(Math.sin(this.polarityPhase)) * 0.7;

                this.ctx.fillStyle = `rgba(77, 166, 255, ${opacity})`;
                this.ctx.font = 'bold 30px sans-serif';
                this.ctx.fillText('δ-', oxygen.x + 30, oxygen.y - 30);

                const hydrogens = this.atoms.filter(a => a.type === 'hydrogen');
                hydrogens.forEach(h => {
                     this.ctx.fillStyle = `rgba(255, 77, 109, ${opacity})`;
                     this.ctx.fillText('δ+', h.x + 20, h.y - 20);
                });
            },

            bindEvents() {
                this.canvas.addEventListener('mousedown', this.onMouseDown.bind(this));
                this.canvas.addEventListener('mousemove', this.onMouseMove.bind(this));
                this.canvas.addEventListener('mouseup', this.onMouseUp.bind(this));
                this.atomSources.forEach(s => s.addEventListener('mousedown', this.onAtomSourceDown.bind(this)));
                this.resetButton.addEventListener('click', this.reset.bind(this));
            },

            onMouseDown(e) {
                if(!app.audioContext) initAudio();
                const mouse = this.getMousePos(e);
                
                this.draggedAtom = this.atoms.slice().reverse().find(atom => this.distance(mouse, atom) < atom.radius);
                if (this.draggedAtom) {
                    this.dragOffset.x = mouse.x - this.draggedAtom.x;
                    this.dragOffset.y = mouse.y - this.draggedAtom.y;
                    if (!this.puzzleSolved) this.severBonds(this.draggedAtom);
                }
            },

            onAtomSourceDown(e) {
                if(!app.audioContext) initAudio();
                const type = e.currentTarget.dataset.type;
                this.draggedAtom = this.createAtom(type, -100, -100);
                this.onMouseMove(e);
            },

            onMouseMove(e) {
                if (!this.draggedAtom) return;
                const mouse = this.getMousePos(e);
                
                const group = this.getMoleculeGroup(this.draggedAtom);
                const dx = (mouse.x - this.dragOffset.x) - group.center.x;
                const dy = (mouse.y - this.dragOffset.y) - group.center.y;
                
                group.atoms.forEach(atom => {
                    atom.x += dx;
                    atom.y += dy;
                });
            },

            onMouseUp(e) {
                if (!this.draggedAtom) return;
                
                let snapped = false;
                for (const targetAtom of this.atoms) {
                    if (targetAtom.id === this.draggedAtom.id) continue;
                    for (const targetSlot of targetAtom.slots) {
                        if (targetSlot.occupied) continue;
                        
                        const targetSlotPos = {
                            x: targetAtom.x + Math.cos(targetSlot.angle + targetAtom.rotation) * (targetAtom.radius + 10),
                            y: targetAtom.y + Math.sin(targetSlot.angle + targetAtom.rotation) * (targetAtom.radius + 10)
                        };

                        if (this.distance(this.draggedAtom, targetSlotPos) < 30) {
                            const mySlot = this.draggedAtom.slots.find(s => !s.occupied);
                            if (mySlot) {
                                this.snap(this.draggedAtom, mySlot, targetAtom, targetSlot);
                                snapped = true;
                                break;
                            }
                        }
                    }
                    if(snapped) break;
                }

                if(!snapped && !this.draggedAtom.bonds.length > 0) playSound('error');

                this.draggedAtom = null;
                if (!this.puzzleSolved) this.checkWinCondition();
            },

            snap(atom1, slot1, atom2, slot2) {
                playSound('snap');
                const angleToTarget = Math.atan2(atom2.y - atom1.y, atom2.x - atom1.x);
                atom1.rotation = angleToTarget - slot1.angle;

                const finalAngle = slot2.angle + atom2.rotation;
                const bondLength = atom1.radius + atom2.radius + 15;
                atom1.x = atom2.x + Math.cos(finalAngle) * bondLength;
                atom1.y = atom2.y + Math.sin(finalAngle) * bondLength;
                
                slot1.occupied = true;
                slot2.occupied = true;
                const bond = { id: Date.now(), atom1: atom1.id, atom2: atom2.id };
                this.bonds.push(bond);
                atom1.bonds.push(bond.id);
                atom2.bonds.push(bond.id);
            },

            severBonds(atom) {
                atom.bonds.forEach(bondId => {
                    const bond = this.bonds.find(b => b.id === bondId);
                    if (!bond) return;
                    const otherAtomId = bond.atom1 === atom.id ? bond.atom2 : bond.atom1;
                    const otherAtom = this.atoms.find(a => a.id === otherAtomId);
                    
                    atom.slots.find(s => s.occupied).occupied = false;
                    if(otherAtom) {
                        otherAtom.slots.find(s => s.occupied).occupied = false;
                        otherAtom.bonds = otherAtom.bonds.filter(id => id !== bondId);
                    }
                    this.bonds = this.bonds.filter(b => b.id !== bondId);
                });
                atom.bonds = [];
                atom.vibrate = 10;
                playSound('error');
            },

            getMoleculeGroup(startAtom) {
                let group = new Set([startAtom]);
                let toCheck = [startAtom];
                while (toCheck.length > 0) {
                    const current = toCheck.pop();
                    current.bonds.forEach(bondId => {
                        const bond = this.bonds.find(b => b.id === bondId);
                        const otherAtomId = bond.atom1 === current.id ? bond.atom2 : bond.atom1;
                        const otherAtom = this.atoms.find(a => a.id === otherAtomId);
                        if (otherAtom && !group.has(otherAtom)) {
                            group.add(otherAtom);
                            toCheck.push(otherAtom);
                        }
                    });
                }
                
                const groupAtoms = [...group];
                const centerX = groupAtoms.reduce((sum, a) => sum + a.x, 0) / groupAtoms.length;
                const centerY = groupAtoms.reduce((sum, a) => sum + a.y, 0) / groupAtoms.length;
                
                return { atoms: groupAtoms, center: {x: centerX, y: centerY}};
            },

            getMousePos(e) {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            },

            distance(p1, p2) { 
                return Math.sqrt((p1.x - p2.x)**2 + (p1.y - p2.y)**2); 
            },

            stop() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
            }
        };

        function setupMoleculeStage() {
            moleculeStage.init();
        }

        // --- שלב 3.2: מגרש המשחקים (3D Physics Sandbox) ---
        const sandbox = {
            scene: null,
            camera: null,
            renderer: null,
            controls: null,
            raycaster: null,
            mouse: null,
            plane: null,
            draggableObjects: [],
            physicsObjects: [],
            magneticFieldSources: [],
            electricFieldLines: [],
            draggedObject: null,
            isInitialized: false,
            animationFrameId: null,
            forceConstant: 20,
            damping: 0.96,

            async init() {
                if (this.isInitialized) return;
                
                try {
                    // ייבוא דינמי של Three.js
                    const THREE = await import('three');
                    const { OrbitControls } = await import('three/addons/controls/OrbitControls.js');
                    
                    // סצנה ומצלמה
                    this.scene = new THREE.Scene();
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    this.camera.position.set(0, 8, 15);

                    // רנדרר
                    const canvas = app.canvases.sandbox;
                    this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

                    // בקרת מצלמה
                    this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                    this.controls.enableDamping = true;
                    this.controls.minDistance = 3;
                    this.controls.maxDistance = 25;

                    // תאורה
                    this.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
                    const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
                    dirLight.position.set(5, 10, 7);
                    this.scene.add(dirLight);
                    
                    // רצפה
                    this.scene.add(new THREE.GridHelper(40, 40, 0xaaaaaa, 0x555555));

                    // מישור גרירה בלתי נראה
                    this.plane = new THREE.Mesh(
                        new THREE.PlaneGeometry(100, 100),
                        new THREE.MeshBasicMaterial({ visible: false, side: THREE.DoubleSide })
                    );
                    this.plane.rotation.x = -Math.PI / 2;
                    this.scene.add(this.plane);

                    // כלי עזר לגרירה
                    this.raycaster = new THREE.Raycaster();
                    this.mouse = new THREE.Vector2();

                    this.bindEvents(THREE);
                    this.isInitialized = true;
                    this.animate();
                    
                } catch (error) {
                    console.error('שגיאה בטעינת השלב התלת-ממדי:', error);
                }
            },

            // מחלקות אובייקטים
            createPhysicsObject(mesh, type, charge = 0) {
                const obj = {
                    mesh: mesh,
                    type: type,
                    charge: charge,
                    velocity: new THREE.Vector3(),
                    force: new THREE.Vector3(),
                    mass: mesh.userData.mass || 1,
                    current: 0,
                    strength: 5,
                    fieldLines: [],
                    
                    update: function() {
                        const acceleration = this.force.clone().divideScalar(this.mass);
                        this.velocity.add(acceleration);
                        this.velocity.multiplyScalar(sandbox.damping);
                        this.mesh.position.add(this.velocity);
                        this.force.set(0, 0, 0);
                        
                        // עדכון ויזואליזציה של שדה מגנטי
                        if (this.type === 'wire' && this.fieldLines.length > 0) {
                            const intensity = Math.abs(this.current);
                            this.fieldLines.forEach(ring => {
                                ring.material.opacity = intensity * 0.5;
                            });
                        }
                    },

                    getMagneticFieldAt: function(point, THREE) {
                        if (this.type === 'wire') {
                            const localPoint = this.mesh.worldToLocal(point.clone());
                            if (Math.abs(localPoint.x) > 5) return new THREE.Vector3();
                            
                            const rVec = new THREE.Vector3(0, localPoint.y, localPoint.z);
                            const r = rVec.length();
                            if (r < 0.1) return new THREE.Vector3();

                            const B_magnitude = (0.5 * this.current) / r;
                            const B_direction = new THREE.Vector3(-this.current, 0, 0).cross(rVec).normalize();
                            
                            return B_direction.multiplyScalar(B_magnitude).applyQuaternion(this.mesh.quaternion);
                        } else if (this.type === 'magnet') {
                            // מודל דיפול פשוט
                            const localPoint = this.mesh.worldToLocal(point.clone());
                            const poleDist = this.mesh.geometry.parameters.height * 0.8;
                            const posPole = new THREE.Vector3(0, poleDist / 2, 0);
                            const negPole = new THREE.Vector3(0, -poleDist / 2, 0);

                            const r_pos = new THREE.Vector3().subVectors(localPoint, posPole);
                            const r_neg = new THREE.Vector3().subVectors(localPoint, negPole);

                            const B_pos = r_pos.clone().multiplyScalar(this.strength / Math.pow(r_pos.length(), 3));
                            const B_neg = r_neg.clone().multiplyScalar(-this.strength / Math.pow(r_neg.length(), 3));

                            const B_total_local = new THREE.Vector3().addVectors(B_pos, B_neg);
                            return B_total_local.applyQuaternion(this.mesh.quaternion);
                        }
                        return new THREE.Vector3();
                    }
                };
                
                return obj;
            },

            async addObject(type) {
                if (!this.isInitialized) return;
                
                const THREE = await import('three');
                let mesh;
                let physicsObj;
                
                switch(type) {
                    case 'proton':
                        mesh = new THREE.Mesh(
                            new THREE.SphereGeometry(0.3), 
                            new THREE.MeshStandardMaterial({ color: 0xff4d6d })
                        );
                        physicsObj = this.createPhysicsObject(mesh, 'proton', 1);
                        break;
                    case 'electron':
                        mesh = new THREE.Mesh(
                            new THREE.SphereGeometry(0.2), 
                            new THREE.MeshStandardMaterial({ color: 0x4da6ff })
                        );
                        mesh.userData.mass = 0.1;
                        physicsObj = this.createPhysicsObject(mesh, 'electron', -1);
                        break;
                    case 'wire':
                        mesh = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.1, 0.1, 10, 16), 
                            new THREE.MeshStandardMaterial({ color: 0xb87333 })
                        );
                        mesh.rotation.z = Math.PI / 2;
                        mesh.userData.mass = 10;
                        physicsObj = this.createPhysicsObject(mesh, 'wire');
                        this.createWireFieldVisual(physicsObj, THREE);
                        this.magneticFieldSources.push(physicsObj);
                        document.getElementById('sandbox-wire-controls').classList.remove('hidden');
                        break;
                    case 'magnet':
                        const magnetGeom = new THREE.BoxGeometry(1, 2, 0.5);
                        const northMat = new THREE.MeshStandardMaterial({ color: 0xff4d6d });
                        const southMat = new THREE.MeshStandardMaterial({ color: 0x4da6ff });
                        const neutralMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa });
                        
                        mesh = new THREE.Mesh(magnetGeom, [northMat, southMat, neutralMat]);
                        mesh.userData.mass = 20;
                        physicsObj = this.createPhysicsObject(mesh, 'magnet');
                        this.magneticFieldSources.push(physicsObj);
                        break;
                }
                
                if (mesh) {
                    mesh.position.y = mesh.geometry.parameters.height ? mesh.geometry.parameters.height / 2 : 0.3;
                    mesh.position.x = (Math.random() - 0.5) * 10;
                    mesh.position.z = (Math.random() - 0.5) * 10;
                    this.scene.add(mesh);
                    this.draggableObjects.push(mesh);
                    this.physicsObjects.push(physicsObj);
                    playSound('add');
                }
            },

            createWireFieldVisual(wireObj, THREE) {
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff00ff,
                    transparent: true,
                    opacity: 0,
                    side: THREE.DoubleSide
                });
                
                for(let i = 1; i <= 5; i++) {
                    const ringGeometry = new THREE.TorusGeometry(i * 0.4, 0.02, 16, 100);
                    const ring = new THREE.Mesh(ringGeometry, ringMaterial.clone());
                    ring.rotation.x = Math.PI / 2;
                    wireObj.fieldLines.push(ring);
                    wireObj.mesh.add(ring);
                }
            },

            animate() {
                if (!this.isInitialized) return;
                this.animationFrameId = requestAnimationFrame(this.animate.bind(this));

                // חישובי פיזיקה
                this.updatePhysics();

                if (this.controls) this.controls.update();
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            },

            async updatePhysics() {
                const THREE = await import('three');
                
                // 1. כוחות חשמליים בין חלקיקים טעונים
                for (let i = 0; i < this.physicsObjects.length; i++) {
                    for (let j = i + 1; j < this.physicsObjects.length; j++) {
                        const p1 = this.physicsObjects[i];
                        const p2 = this.physicsObjects[j];
                        
                        if ((p1.type === 'proton' || p1.type === 'electron') && 
                            (p2.type === 'proton' || p2.type === 'electron')) {
                            const vec = new THREE.Vector3().subVectors(p1.mesh.position, p2.mesh.position);
                            const distSq = vec.lengthSq();
                            if (distSq > 0.1) {
                                const forceMag = -this.forceConstant * (p1.charge * p2.charge) / distSq;
                                const forceVec = vec.normalize().multiplyScalar(forceMag);
                                p1.force.add(forceVec);
                                p2.force.sub(forceVec);
                            }
                        }
                    }
                }
                
                // 2. כוחות מגנטיים
                this.physicsObjects.forEach(p => {
                    const totalB = new THREE.Vector3();
                    this.magneticFieldSources.forEach(source => {
                        totalB.add(source.getMagneticFieldAt(p.mesh.position, THREE));
                    });

                    if ((p.type === 'proton' || p.type === 'electron') && p.velocity.lengthSq() > 0.0001) {
                        // כוח לורנץ על חלקיקים נעים
                        const lorentzForce = new THREE.Vector3().crossVectors(p.velocity, totalB).multiplyScalar(p.charge);
                        p.force.add(lorentzForce);
                    }
                    
                    if (p.type === 'wire' && p.current !== 0) {
                        // כוח על תיל עם זרם
                        const wireDirection = new THREE.Vector3(-1, 0, 0).applyQuaternion(p.mesh.quaternion);
                        const wireForce = new THREE.Vector3().crossVectors(wireDirection, totalB).multiplyScalar(p.current * 10);
                        p.force.add(wireForce);
                    }
                });

                // עדכון מיקומים
                this.physicsObjects.forEach(p => p.update());
            },

            reset() {
                this.physicsObjects.forEach(p => this.scene.remove(p.mesh));
                this.electricFieldLines.forEach(l => this.scene.remove(l));
                this.physicsObjects = [];
                this.draggableObjects = [];
                this.magneticFieldSources = [];
                this.electricFieldLines = [];
                document.getElementById('sandbox-wire-controls').classList.add('hidden');
            },

            bindEvents(THREE) {
                // כפתורי ארגז הכלים
                document.querySelectorAll('.tool-item').forEach(el => {
                    el.addEventListener('click', () => this.addObject(el.dataset.type));
                });
                
                // מחוון זרם
                document.getElementById('sandbox-current-slider').addEventListener('input', e => {
                    const wireObj = this.physicsObjects.find(p => p.type === 'wire');
                    if(wireObj) wireObj.current = (e.target.value - 50) / 50; // טווח -1 עד 1
                });

                // גרירה
                const canvas = this.renderer.domElement;
                canvas.addEventListener('pointerdown', (e) => this.onPointerDown(e, THREE));
                canvas.addEventListener('pointermove', (e) => this.onPointerMove(e, THREE));
                canvas.addEventListener('pointerup', () => this.onPointerUp());

                // שינוי גודל חלון
                window.addEventListener('resize', () => {
                    if (this.camera && this.renderer) {
                        this.camera.aspect = window.innerWidth / window.innerHeight;
                        this.camera.updateProjectionMatrix();
                        this.renderer.setSize(window.innerWidth, window.innerHeight);
                    }
                });
            },

            onPointerDown(event, THREE) {
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                const intersects = this.raycaster.intersectObjects(this.draggableObjects);
                if (intersects.length > 0) {
                    this.controls.enabled = false;
                    this.draggedObject = intersects[0].object;
                    this.plane.position.copy(this.draggedObject.position);
                    this.plane.lookAt(this.camera.position);
                    playSound('grab');
                }
            },

            onPointerMove(event, THREE) {
                if (!this.draggedObject) return;
                
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                const intersects = this.raycaster.intersectObject(this.plane);
                if (intersects.length > 0) {
                    this.draggedObject.position.copy(intersects[0].point);
                    // שמירה על גובה קבוע
                    if (this.draggedObject.geometry.type === 'SphereGeometry') {
                        this.draggedObject.position.y = this.draggedObject.geometry.parameters.radius;
                    } else if (this.draggedObject.geometry.type === 'BoxGeometry') {
                        this.draggedObject.position.y = this.draggedObject.geometry.parameters.height / 2;
                    }
                }
            },

            onPointerUp() {
                if (this.draggedObject) {
                    playSound('release');
                    this.controls.enabled = true;
                    this.draggedObject = null;
                }
            },

            stop() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
            }
        };

        function setupSandboxStage() {
            sandbox.init();
        }

        // --- שלב 2.2: סימפוניית האור ---
        const waveStage = {
            canvas: null,
            ctx: null,
            slider: null,
            infoText: null,
            spectrumLabels: null,
            waveOscillator: null,
            waveGain: null,
            isInitialized: false,
            animationFrameId: null,

            wave: {
                phase: 0,
                amplitude: 0,
                frequency: 0.05,
                speed: 0.05,
                points: 200,
            },

            SPECTRUM: {
                radio:     { range: [0, 150],   name: 'גלי רדיו' },
                microwave: { range: [151, 300],  name: 'גלי מיקרו' },
                infrared:  { range: [301, 450],  name: 'אינפרא-אדום' },
                visible:   { range: [451, 650],  name: 'אור נראה' },
                uv:        { range: [651, 800],  name: 'אולטרה-סגול' },
                xray:      { range: [801, 950],  name: 'קרני רנטגן' },
                gamma:     { range: [951, 1000], name: 'קרני גמא' },
            },

            init() {
                if (this.isInitialized) return;
                
                this.canvas = document.getElementById('wave-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.slider = document.getElementById('frequency-slider');
                this.infoText = document.getElementById('radiation-type');
                this.spectrumLabels = document.querySelectorAll('#spectrum-bar .label');

                if (!this.canvas || !this.slider) return;

                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.wave.amplitude = this.canvas.height / 4;

                this.bindEvents();
                this.updateFromSlider();
                this.isInitialized = true;
                this.animate();
            },

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const { currentType, color } = this.getCurrentSpectrumInfo();

                const electricPath = new Path2D();
                const magneticPath = new Path2D();
                
                for (let i = 0; i <= this.wave.points; i++) {
                    const progress = i / this.wave.points;
                    const x = progress * this.canvas.width;
                    
                    const perspective = 0.4 + (1 - progress) * 0.6;
                    
                    const angle = this.wave.frequency * i + this.wave.phase;
                    const y = centerY + Math.sin(angle) * this.wave.amplitude * perspective;
                    const z = Math.cos(angle) * this.wave.amplitude * 0.5 * perspective;

                    if (i === 0) {
                        electricPath.moveTo(x, y);
                        magneticPath.moveTo(x, centerY - z);
                    } else {
                        electricPath.lineTo(x, y);
                        magneticPath.lineTo(x, centerY - z);
                    }
                }
                
                const electricColor = (currentType === 'visible') ? color : varToHex('--accent-cyan');
                const magneticColor = (currentType === 'visible') ? color : varToHex('--accent-magenta');
                
                this.drawWave(magneticPath, magneticColor, 0.7);
                this.drawWave(electricPath, electricColor, 1.0);
            },

            drawWave(path, color, alpha) {
                this.ctx.strokeStyle = color;
                this.ctx.globalAlpha = alpha;
                this.ctx.lineWidth = 3;
                this.ctx.shadowColor = color;
                this.ctx.shadowBlur = 15;
                this.ctx.stroke(path);
                this.ctx.shadowBlur = 0;
            },
            
            updateFromSlider() {
                const value = parseFloat(this.slider.value);
                this.wave.frequency = (value / 1000) * 0.25 + 0.02;

                const { name, currentType, color } = this.getCurrentSpectrumInfo();
                this.infoText.innerHTML = name;
                if(color) {
                    this.infoText.style.color = color;
                    this.infoText.style.textShadow = `0 0 8px ${color}`;
                } else {
                    this.infoText.style.color = '#fff';
                    this.infoText.style.textShadow = '0 0 8px #fff';
                }

                this.spectrumLabels.forEach(label => {
                    label.classList.toggle('active', label.dataset.range === currentType);
                });
                
                this.updateSound(value);
            },
            
            getCurrentSpectrumInfo() {
                const value = this.slider.value;
                for (const type in this.SPECTRUM) {
                    const { range, name } = this.SPECTRUM[type];
                    if (value >= range[0] && value <= range[1]) {
                        if (type === 'visible') {
                            const visibleProgress = (value - range[0]) / (range[1] - range[0]);
                            const hue = (1 - visibleProgress) * 240;
                            const color = `hsl(${hue}, 100%, 50%)`;
                            return { name: `${name}: ${this.getVisibleColorName(hue)}`, currentType: type, color: color };
                        }
                        return { name, currentType: type, color: null };
                    }
                }
                return { name: 'לא ידוע', currentType: null, color: null };
            },

            getVisibleColorName(hue) {
                if (hue > 200) return 'סגול';
                if (hue > 150) return 'כחול';
                if (hue > 90) return 'ירוק';
                if (hue > 45) return 'צהוב';
                if (hue > 20) return 'כתום';
                return 'אדום';
            },

            initAudio() {
                if (this.waveOscillator || !app.audioContext) return;
                try {
                    this.waveOscillator = app.audioContext.createOscillator();
                    this.waveGain = app.audioContext.createGain();

                    this.waveOscillator.type = 'sine';
                    this.waveGain.gain.setValueAtTime(0, app.audioContext.currentTime);

                    this.waveOscillator.connect(this.waveGain);
                    this.waveGain.connect(app.audioContext.destination);
                    this.waveOscillator.start();
                } catch (e) {
                    console.warn('שגיאה באתחול אודיו לשלב הגלים:', e);
                }
            },

            updateSound(value) {
                if (!this.waveGain || !app.audioContext) return;
                const minFreq = 100;
                const maxFreq = 1000;
                const freq = minFreq * Math.pow(maxFreq / minFreq, value / 1000);
                
                this.waveOscillator.frequency.setTargetAtTime(freq, app.audioContext.currentTime, 0.05);
                this.waveGain.gain.setTargetAtTime(0.1, app.audioContext.currentTime, 0.1);
            },

            animate() {
                this.draw();
                this.wave.phase += this.wave.speed;
                this.animationFrameId = requestAnimationFrame(this.animate.bind(this));
            },

            bindEvents() {
                this.slider.addEventListener('input', () => this.updateFromSlider());
                this.slider.addEventListener('mousedown', () => this.initAudio());
                this.slider.addEventListener('touchstart', () => this.initAudio(), { passive: true });
                
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                    this.wave.amplitude = this.canvas.height / 4;
                });
            },

            stop() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                if (this.waveOscillator) {
                    this.waveOscillator.stop();
                    this.waveOscillator = null;
                    this.waveGain = null;
                }
            }
        };

        function setupWaveStage() {
            waveStage.init();
        }

        // --- עדכון חיבור אירועים ---
        function bindEvents() {
            app.buttons.start.addEventListener('click', () => {
                if(!app.audioContext) initAudio();
                playSound('start');
                switchScreen('stage1_1');
                simulation.start();
            });

            app.buttons.addProton.addEventListener('click', () => simulation.addParticle('proton'));
            app.buttons.addElectron.addEventListener('click', () => simulation.addParticle('electron'));
            app.buttons.reset.addEventListener('click', () => simulation.reset());
            
            // כפתורי מעבר בין שלבים
            if (app.buttons.toStage2) {
                app.buttons.toStage2.addEventListener('click', () => {
                    switchScreen('stage1_2');
                });
            }
            
            if (app.buttons.toStage3) {
                app.buttons.toStage3.addEventListener('click', () => {
                    switchScreen('stage2_1');
                });
            }
            
            if (app.buttons.toStage4) {
                app.buttons.toStage4.addEventListener('click', () => {
                    switchScreen('stage2_2');
                });
            }
            
            if (app.buttons.toStage5) {
                app.buttons.toStage5.addEventListener('click', () => {
                    switchScreen('stage3_1');
                });
            }
            
            if (app.buttons.toStage6) {
                app.buttons.toStage6.addEventListener('click', () => {
                    switchScreen('stage3_2');
                });
            }
            
            if (app.buttons.backToStage1) {
                app.buttons.backToStage1.addEventListener('click', () => {
                    switchScreen('stage1_1');
                });
            }
            
            if (app.buttons.backToStage2) {
                app.buttons.backToStage2.addEventListener('click', () => {
                    switchScreen('stage1_2');
                });
            }
            
            if (app.buttons.backToStage3) {
                app.buttons.backToStage3.addEventListener('click', () => {
                    switchScreen('stage2_1');
                });
            }
            
            if (app.buttons.backToStage4) {
                app.buttons.backToStage4.addEventListener('click', () => {
                    switchScreen('stage2_2');
                });
            }
            
            if (app.buttons.nextStage) {
                app.buttons.nextStage.addEventListener('click', () => {
                    switchScreen('stage2_1');
                });
            }
            
            if (app.buttons.moleculeNextStage) {
                app.buttons.moleculeNextStage.addEventListener('click', () => {
                    switchScreen('stage3_2');
                });
            }
            
            if (app.buttons.backToStage5) {
                app.buttons.backToStage5.addEventListener('click', () => {
                    switchScreen('stage3_1');
                });
            }
            
            if (app.buttons.sandboxReset) {
                app.buttons.sandboxReset.addEventListener('click', () => {
                    sandbox.reset();
                });
            }
        }

        // --- עדכון פונקציית החלפת מסכים ---
        function switchScreen(screenName) {
            // עצירת סימולציות קודמות
            if (app.activeScreen === 'stage1_1') {
                simulation.stop();
            } else if (app.activeScreen === 'stage1_2') {
                atomLab.stop();
            } else if (app.activeScreen === 'stage2_1') {
                magneticStage.stop();
            } else if (app.activeScreen === 'stage2_2') {
                waveStage.stop();
            } else if (app.activeScreen === 'stage3_1') {
                moleculeStage.stop();
            } else if (app.activeScreen === 'stage3_2') {
                sandbox.stop();
            }

            app.screens[app.activeScreen].classList.remove('active');
            app.screens[screenName].classList.add('active');
            app.activeScreen = screenName;

            // התחלת סימולציה חדשה
            if (screenName === 'stage1_1') {
                simulation.start();
            } else if (screenName === 'stage1_2') {
                atomLab.reset();
                setTimeout(() => {
                    atomLab.init();
                    atomLab.start();
                }, 100);
            } else if (screenName === 'stage2_1') {
                setupMagneticStage();
            } else if (screenName === 'stage2_2') {
                setupWaveStage();
            } else if (screenName === 'stage3_1') {
                setupMoleculeStage();
            } else if (screenName === 'stage3_2') {
                setupSandboxStage();
            }
        }

        

        // --- התחלת הכל ---
        setupStarsBackground();
        simulation.init();
        bindEvents();
    });
    </script>
</body>
</html>